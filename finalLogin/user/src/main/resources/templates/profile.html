<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ ìˆ˜ì •</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }        .profile-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            margin-top: 5vh;
            padding: 3rem;
        }
        .form-control {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-verify {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: none;
            color: white;
        }
        .btn-update {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            border: none;
            color: white;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            text-align: center;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
        .profile-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .password-setup-section {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }        .password-strength {
            height: 5px;
            border-radius: 3px;
            margin-top: 5px;
            transition: all 0.3s ease;
        }
        .strength-weak { background: #ff6b6b; }
        .strength-medium { background: #ffa726; }
        .strength-strong { background: #4caf50; }
        
        .password-requirements {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .password-feedback {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            min-height: 1.2rem;
        }
        
        .password-match-feedback {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            min-height: 1.2rem;
        }
        
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
          #messageArea .alert, #generalMessageArea .alert {
            border-radius: 15px;
            border: none;
            margin-bottom: 1rem;
        }
        
        .delete-account-section {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            color: white;
        }
        
        .btn-danger-custom {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            border: none;
            color: white;
        }
        
        .btn-danger-custom:hover {
            background: linear-gradient(135deg, #ff3838 0%, #ff2f2f 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="profile-container">
                    <div class="logo">ğŸ‘¤ í”„ë¡œí•„ ìˆ˜ì •</div>

                    <div class="profile-info" th:if="${member}">
                        <h5>í˜„ì¬ ì •ë³´</h5>
                        <p><strong>ì´ë¦„:</strong> <span th:text="${member.name}">ì‚¬ìš©ì ì´ë¦„</span></p>
                        <p><strong>ì´ë©”ì¼:</strong> <span th:text="${member.email}">user@example.com</span></p>
                        <p><strong>ê°€ì…ì¼:</strong> <span th:text="${#temporals.format(member.createdAt, 'yyyy-MM-dd')}">2023-01-01</span></p>
                        <p><strong>ë¡œê·¸ì¸ ë°©ì‹:</strong> 
                            <span th:if="${member.provider.name() == 'LOCAL'}" class="badge bg-primary">ì¼ë°˜ ë¡œê·¸ì¸</span>
                            <span th:if="${member.provider.name() == 'GOOGLE'}" class="badge bg-danger">Google</span>
                            <span th:if="${member.provider.name() == 'NAVER'}" class="badge bg-success">Naver</span>
                            <span th:if="${member.provider.name() == 'KAKAO'}" class="badge bg-warning">Kakao</span>
                        </p>
                    </div>                    <div th:if="${!canUpdate and isSocialUser}" class="password-setup-section">
                        <div class="alert alert-info">
                            <h5>ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h5>
                            <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì‹œë©´ ì†Œì…œ ë¡œê·¸ì¸ê³¼ ì¼ë°˜ ë¡œê·¸ì¸ì„ ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ë©”ì‹œì§€ ì˜ì—­ ì¶”ê°€ -->
                        <div id="messageArea"></div>                        <form id="setPasswordForm">
                            <div class="mb-3">
                                <label for="socialNewPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" class="form-control" id="socialNewPassword" required>
                                <div class="password-requirements">ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ</div>
                                <div class="password-feedback" id="socialPasswordStrength"></div>
                            </div>
                            <div class="mb-3">
                                <label for="socialConfirmPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                <input type="password" class="form-control" id="socialConfirmPassword" required>
                                <div class="password-match-feedback" id="socialPasswordMatch"></div>
                            </div>
                            <button type="submit" class="btn btn-update btn-custom">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •í•˜ê³  ì¼ë°˜ ì‚¬ìš©ìë¡œ ì „í™˜</button>
                        </form></div>

                    <!-- ì¼ë°˜ ì‚¬ìš©ì í”„ë¡œí•„ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì™„ë£Œ í›„) -->
                    <div th:if="${canUpdate}" class="profile-edit-section">

                        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
                        <div id="generalMessageArea"></div>

                        <!-- 1ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
                        <div id="step1" class="step active">
                            <h4 class="mb-3">ğŸ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h4>
                            <p class="text-muted mb-3">ë³´ì•ˆì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                            
                            <form id="passwordVerifyForm">
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="currentPassword" 
                                           placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required>
                                </div>
                                <button type="submit" class="btn btn-verify btn-custom">
                                    ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                                </button>
                                <a href="/main" class="btn btn-secondary btn-custom">
                                    ë©”ì¸ìœ¼ë¡œ ê°€ê¸°
                                </a>
                            </form>
                        </div>
                    
                        <!-- 2ë‹¨ê³„: í”„ë¡œí•„ ìˆ˜ì • -->
                        <div id="step2" class="step">
                            <h4 class="mb-3">âœï¸ ì •ë³´ ìˆ˜ì •</h4>
                            
                            <form id="updateForm">
                                <div class="mb-3">
                                    <label for="newName" class="form-label">ì´ë¦„</label>
                                    <input type="text" class="form-control" id="newName" name="name" 
                                           th:value="${member?.name}" required>
                                </div>
                                  <div class="mb-3">
                                    <label for="newPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”)</label>
                                    <input type="password" class="form-control" id="newPassword" name="password">
                                    <div class="password-requirements">ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ</div>
                                    <div class="password-feedback" id="newPasswordStrength"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirmNewPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                    <input type="password" class="form-control" id="confirmNewPassword">
                                    <div class="password-match-feedback" id="newPasswordMatch"></div>
                                </div>
                                  <button type="submit" class="btn btn-update btn-custom">
                                    ì •ë³´ ìˆ˜ì •
                                </button>
                                <button type="button" class="btn btn-secondary btn-custom" onclick="goToStep1()">
                                    ì´ì „ìœ¼ë¡œ
                                </button>
                            </form>
                            
                            <!-- íšŒì›íƒˆí‡´ ì„¹ì…˜ -->
                            <div class="delete-account-section mt-4">
                                <h5>âš ï¸ íšŒì›íƒˆí‡´</h5>
                                <p>íšŒì›íƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p><strong>íƒˆí‡´ í›„ ì‚­ì œë˜ëŠ” ì •ë³´:</strong></p>
                                <ul>
                                    <li>ê°œì¸ì •ë³´ (ì´ë¦„, ì´ë©”ì¼ ë“±)</li>
                                    <li>ë¡œê·¸ì¸ ì •ë³´</li>
                                    <li>ëª¨ë“  í™œë™ ê¸°ë¡</li>
                                </ul>
                                <div id="deleteMessageArea"></div>
                                <button type="button" class="btn btn-danger-custom btn-custom" onclick="confirmDeleteAccount()">
                                    íšŒì›íƒˆí‡´
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜ˆì™¸ ìƒí™© -->
                    <div th:if="${!canUpdate and !isSocialUser}" class="alert alert-warning">
                        <h5>âš ï¸ ì ‘ê·¼ ì œí•œ</h5>
                        <p>í”„ë¡œí•„ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                        <a href="/login" class="btn btn-primary">ë¡œê·¸ì¸</a>
                    </div>

                    <!-- ê¸°íƒ€ ì¼ë°˜ ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ í¼ ìƒëµ -->
                </div>
            </div>
        </div>
    </div>    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ì†Œì…œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ê´€ë ¨ ìš”ì†Œë“¤
            const socialNewPassword = document.getElementById('socialNewPassword');
            const socialConfirmPassword = document.getElementById('socialConfirmPassword');
            const socialPasswordStrength = document.getElementById('socialPasswordStrength');
            const socialPasswordMatch = document.getElementById('socialPasswordMatch');
            const setPasswordForm = document.getElementById('setPasswordForm');
            const messageArea = document.getElementById('messageArea');

            // ì¼ë°˜ ì‚¬ìš©ì í”„ë¡œí•„ ìˆ˜ì • ê´€ë ¨ ìš”ì†Œë“¤
            const passwordVerifyForm = document.getElementById('passwordVerifyForm');
            const updateForm = document.getElementById('updateForm');
            const currentPassword = document.getElementById('currentPassword');
            const newName = document.getElementById('newName');
            const newPassword = document.getElementById('newPassword');
            const confirmNewPassword = document.getElementById('confirmNewPassword');
            const newPasswordStrength = document.getElementById('newPasswordStrength');
            const newPasswordMatch = document.getElementById('newPasswordMatch');
            const generalMessageArea = document.getElementById('generalMessageArea');
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');

            // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showMessage(message, type = 'info', targetArea = messageArea) {
                if (targetArea) {
                    targetArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                }
            }

            // ë‹¨ê³„ ì „í™˜ í•¨ìˆ˜
            function goToStep1() {
                if (step1 && step2) {
                    step1.classList.add('active');
                    step2.classList.remove('active');
                }
                if (generalMessageArea) {
                    generalMessageArea.innerHTML = '';
                }
            }

            function goToStep2() {
                if (step1 && step2) {
                    step1.classList.remove('active');
                    step2.classList.add('active');
                }
            }

            // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (HTMLì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡)
            window.goToStep1 = goToStep1;

            // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì‚¬ í•¨ìˆ˜
            function checkPasswordStrength(password) {
                const hasLetter = /[a-zA-Z]/.test(password);
                const hasDigit = /\d/.test(password);
                const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
                const isLongEnough = password.length >= 8;
                const score = [hasLetter, hasDigit, hasSpecial, isLongEnough].filter(Boolean).length;

                if (score < 2 || !isLongEnough) {
                    return { 
                        html: '<span class="text-danger">ì•½í•¨ - ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ í•„ìš”</span>', 
                        class: 'strength-weak', 
                        isValid: false 
                    };
                }
                if (score === 3) {
                    return { 
                        html: '<span class="text-warning">ë³´í†µ - ëª¨ë“  ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë” ì•ˆì „í•©ë‹ˆë‹¤</span>', 
                        class: 'strength-medium', 
                        isValid: hasLetter && hasDigit && hasSpecial && isLongEnough
                    };
                }
                if (score === 4) {
                    return { 
                        html: '<span class="text-success">ê°•í•¨ - ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤</span>', 
                        class: 'strength-strong', 
                        isValid: true 
                    };
                }
                return { html: '<span class="text-danger">ì•½í•¨</span>', class: 'strength-weak', isValid: false };
            }            // === ì†Œì…œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ë¡œì§ ===
            if (socialNewPassword && socialConfirmPassword) {
                socialNewPassword.addEventListener('input', function () {
                    const result = checkPasswordStrength(this.value);
                    if (socialPasswordStrength) {
                        socialPasswordStrength.innerHTML = result.html;
                    }
                });

                socialConfirmPassword.addEventListener('input', function () {
                    if (socialPasswordMatch) {
                        if (this.value === socialNewPassword.value) {
                            socialPasswordMatch.innerHTML = '<span class="text-success">âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤</span>';
                        } else {
                            socialPasswordMatch.innerHTML = '<span class="text-danger">âœ— ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>';
                        }
                    }
                });
            }

            if (setPasswordForm) {
                setPasswordForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const password = socialNewPassword.value;
                    const confirmPassword = socialConfirmPassword.value;

                    if (password !== confirmPassword) {
                        showMessage('ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
                        return;
                    }

                    const strength = checkPasswordStrength(password);
                    if (!strength.isValid) {
                        showMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ìœ¼ë¡œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'danger');
                        return;
                    }

                    showMessage('ğŸ”„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

                    try {
                        const response = await fetch('/api/auth/set-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                password: password,
                                confirmPassword: confirmPassword
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            showMessage('âœ… ' + data.data + ' í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            showMessage('âŒ ' + data.message, 'danger');
                        }
                    } catch (error) {
                        showMessage('âŒ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    }
                });
            }            // === ì¼ë°˜ ì‚¬ìš©ì í”„ë¡œí•„ ìˆ˜ì • ë¡œì§ ===
            if (newPassword && confirmNewPassword) {
                newPassword.addEventListener('input', function () {
                    if (this.value) {
                        const result = checkPasswordStrength(this.value);
                        if (newPasswordStrength) {
                            newPasswordStrength.innerHTML = result.html;
                        }
                    } else {
                        if (newPasswordStrength) {
                            newPasswordStrength.innerHTML = '';
                        }
                    }
                });

                confirmNewPassword.addEventListener('input', function () {
                    if (newPasswordMatch) {
                        if (newPassword.value && this.value) {
                            if (this.value === newPassword.value) {
                                newPasswordMatch.innerHTML = '<span class="text-success">âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤</span>';
                            } else {
                                newPasswordMatch.innerHTML = '<span class="text-danger">âœ— ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>';
                            }
                        } else {
                            newPasswordMatch.innerHTML = '';
                        }
                    }
                });
            }

            // 1ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            if (passwordVerifyForm) {
                passwordVerifyForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const password = currentPassword.value;
                    if (!password) {
                        showMessage('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger', generalMessageArea);
                        return;
                    }

                    showMessage('ğŸ”„ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info', generalMessageArea);

                    try {
                        const response = await fetch('/api/auth/verify-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({ password: password })
                        });

                        const data = await response.json();

                        if (data.success) {
                            showMessage('âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!', 'success', generalMessageArea);
                            setTimeout(() => {
                                goToStep2();
                            }, 1000);
                        } else {
                            showMessage('âŒ ' + data.message, 'danger', generalMessageArea);
                            currentPassword.value = '';
                        }
                    } catch (error) {
                        showMessage('âŒ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger', generalMessageArea);
                    }
                });
            }

            // 2ë‹¨ê³„: ì •ë³´ ìˆ˜ì •
            if (updateForm) {
                updateForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const name = newName.value.trim();
                    const password = newPassword.value;
                    const confirmPassword = confirmNewPassword.value;

                    if (!name) {
                        showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger', generalMessageArea);
                        return;
                    }

                    // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì‹œ ìœ íš¨ì„± ê²€ì‚¬
                    if (password) {
                        if (password !== confirmPassword) {
                            showMessage('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger', generalMessageArea);
                            return;
                        }

                        const strength = checkPasswordStrength(password);
                        if (!strength.isValid) {
                            showMessage('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ìœ¼ë¡œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'danger', generalMessageArea);
                            return;
                        }
                    }

                    showMessage('ğŸ”„ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info', generalMessageArea);

                    try {
                        const requestData = {
                            name: name,
                            currentPassword: currentPassword.value
                        };

                        if (password) {
                            requestData.password = password;
                        }

                        const response = await fetch('/api/auth/update-profile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            showMessage('âœ… ' + data.data + ' ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success', generalMessageArea);
                            setTimeout(() => {
                                window.location.href = '/main';
                            }, 2000);
                        } else {
                            showMessage('âŒ ' + data.message, 'danger', generalMessageArea);
                        }                    } catch (error) {
                        showMessage('âŒ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger', generalMessageArea);
                    }
                });
            }

            // === íšŒì›íƒˆí‡´ ê´€ë ¨ í•¨ìˆ˜ ===
            window.confirmDeleteAccount = function () {
                const deleteMessageArea = document.getElementById('deleteMessageArea');
                
                if (confirm('ì •ë§ë¡œ íšŒì›íƒˆí‡´ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œë ¤ë©´ "í™•ì¸"ì„ í´ë¦­í•˜ì„¸ìš”.')) {
                    if (confirm('ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤.\n\nì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        deleteAccount(deleteMessageArea);
                    }
                }
            };            async function deleteAccount(messageArea) {
                // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (1ë‹¨ê³„ì—ì„œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸)
                const currentPasswordValue = currentPassword.value;
                
                if (!currentPasswordValue) {
                    showMessage('âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'danger', messageArea);
                    return;
                }
                
                showMessage('ğŸ”„ íšŒì›íƒˆí‡´ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'warning', messageArea);

                try {
                    // ê°œì„ ëœ íšŒì›íƒˆí‡´ ì‹œì‘ API í˜¸ì¶œ
                    const response = await fetch('/api/auth/initiate-delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            currentPassword: currentPasswordValue
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const result = data.data;
                        
                        if (result.type === 'social') {
                            // ì†Œì…œ ì‚¬ìš©ì: ì†Œì…œ ë¡œê·¸ì•„ì›ƒ URLë¡œ ì´ë™
                            showMessage(`ğŸ”„ ${result.provider} ë¡œê·¸ì•„ì›ƒ í›„ íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë©ë‹ˆë‹¤...`, 'info', messageArea);
                            
                            setTimeout(() => {
                                window.location.href = result.logoutUrl;
                            }, 2000);                        } else {
                            // ì¼ë°˜ ì‚¬ìš©ì: ë°”ë¡œ íƒˆí‡´ ì™„ë£Œ
                            showMessage('âœ… ' + result.message, 'success', messageArea);
                            
                            // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í† í° ì •ë¦¬
                            clearClientTokens();
                            
                            setTimeout(() => {
                                window.location.href = '/delete-account-complete';
                            }, 2000);
                        }
                    } else {
                        showMessage('âŒ ' + data.message, 'danger', messageArea);
                    }
                } catch (error) {
                    console.error('íšŒì›íƒˆí‡´ ì˜¤ë¥˜:', error);
                    showMessage('âŒ íšŒì›íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger', messageArea);
                }
            }

            /**
             * í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í† í° ì •ë¦¬
             */
            function clearClientTokens() {
                // ì¿ í‚¤ ì‚­ì œ
                const cookiesToClear = ['accessToken', 'refreshToken', 'JSESSIONID'];
                cookiesToClear.forEach(cookieName => {
                    document.cookie = `${cookieName}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;`;
                    document.cookie = `${cookieName}=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:01 GMT;`;
                });
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('user');
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
                sessionStorage.clear();
                
                console.log('í´ë¼ì´ì–¸íŠ¸ í† í° ì •ë¦¬ ì™„ë£Œ');
            }
        });
    </script>
</body>
</html>
