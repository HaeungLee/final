<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì•„ì›ƒ ì¤‘...</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logout-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        .logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
        }
        .message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 2rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .countdown {
            font-size: 0.9rem;
            color: #999;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="logout-container">
        <div class="logo">ğŸ”„</div>
        <div class="title">ë¡œê·¸ì•„ì›ƒ ì¤‘...</div>
        <div class="spinner"></div>        <div class="message">
            ì†Œì…œ ê³„ì •ì—ì„œ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì•„ì›ƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
            <span th:if="${provider == 'naver'}">
                ğŸ”‘ ë„¤ì´ë²„ í† í° ì—°ë™ í•´ì œ ì¤‘...<br>
                ğŸ§¹ ë¸Œë¼ìš°ì € ì„¸ì…˜ ì •ë¦¬ ì¤‘...
            </span>
            <span th:if="${provider != 'naver'}">
                ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
            </span>
        </div><div class="countdown" id="countdown">
            <span id="seconds">2</span>ì´ˆ í›„ ìë™ìœ¼ë¡œ ì™„ë£Œë©ë‹ˆë‹¤.
        </div>
    </div>    <script th:inline="javascript">
        /*<![CDATA[*/
        const provider = /*[[${provider}]]*/ '';
        const socialLogoutUrl = /*[[${param.socialLogoutUrl}]]*/ '';
        /*]]>*/

        console.log('ì†Œì…œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹œì‘:', provider, socialLogoutUrl);

        // 1. ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì™„ì „ ì •ë¦¬
        function clearBrowserStorage() {
            console.log('ğŸ§¹ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì •ë¦¬ ì‹œì‘');
            
            try {
                // localStorage ì •ë¦¬
                if (window.localStorage) {
                    const localStorageKeys = Object.keys(localStorage);
                    console.log('localStorage í•­ëª©ë“¤:', localStorageKeys);
                    
                    // OAuth2 ê´€ë ¨ í‚¤ë“¤ ì •ë¦¬
                    const oauthKeys = localStorageKeys.filter(key => 
                        key.toLowerCase().includes('oauth') ||
                        key.toLowerCase().includes('token') ||
                        key.toLowerCase().includes('auth') ||
                        key.toLowerCase().includes('naver') ||
                        key.toLowerCase().includes('google') ||
                        key.toLowerCase().includes('kakao')
                    );
                    
                    oauthKeys.forEach(key => {
                        localStorage.removeItem(key);
                        console.log('localStorage ì‚­ì œ:', key);
                    });
                    
                    // ì „ì²´ localStorage ì •ë¦¬ (ì„ íƒì )
                    localStorage.clear();
                    console.log('âœ… localStorage ì „ì²´ ì •ë¦¬ ì™„ë£Œ');
                }
                
                // sessionStorage ì •ë¦¬
                if (window.sessionStorage) {
                    const sessionStorageKeys = Object.keys(sessionStorage);
                    console.log('sessionStorage í•­ëª©ë“¤:', sessionStorageKeys);
                    
                    sessionStorage.clear();
                    console.log('âœ… sessionStorage ì „ì²´ ì •ë¦¬ ì™„ë£Œ');
                }
                
                // IndexedDB ì •ë¦¬ (ê³ ê¸‰)
                if (window.indexedDB) {
                    try {
                        // ë„¤ì´ë²„, êµ¬ê¸€, ì¹´ì¹´ì˜¤ ê´€ë ¨ IndexedDB ì •ë¦¬
                        const dbNames = ['naver-auth', 'google-auth', 'kakao-auth', 'oauth2-cache'];
                        dbNames.forEach(dbName => {
                            const deleteReq = indexedDB.deleteDatabase(dbName);
                            deleteReq.onsuccess = () => console.log(`IndexedDB ${dbName} ì‚­ì œ ì™„ë£Œ`);
                            deleteReq.onerror = () => console.log(`IndexedDB ${dbName} ì‚­ì œ ì‹¤íŒ¨`);
                        });
                    } catch (e) {
                        console.warn('IndexedDB ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
                    }
                }
                
                console.log('âœ… ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì •ë¦¬ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // 2. ë„¤ì´ë²„ íŠ¹í™” ì •ë¦¬ í•¨ìˆ˜
        function clearNaverSpecificData() {
            if (provider === 'naver') {
                console.log('ğŸŸ¢ ë„¤ì´ë²„ íŠ¹í™” ë°ì´í„° ì •ë¦¬ ì‹œì‘');
                
                // ë„¤ì´ë²„ ì¿ í‚¤ ê°•ì œ ì‚­ì œ (JavaScriptë¡œ ê°€ëŠ¥í•œ ê²ƒë“¤)
                const naverCookies = ['NID_AUT', 'NID_SES', 'NID_JKL', 'NAVER_OPEN_RCVR', 'npic'];
                naverCookies.forEach(cookieName => {
                    // í˜„ì¬ ë„ë©”ì¸ì—ì„œ ì‚­ì œ
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                    // .naver.com ë„ë©”ì¸ì—ì„œ ì‚­ì œ ì‹œë„
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.naver.com;`;
                    console.log('ë„¤ì´ë²„ ì¿ í‚¤ ì‚­ì œ ì‹œë„:', cookieName);
                });
                
                console.log('âœ… ë„¤ì´ë²„ íŠ¹í™” ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
            }
        }        // ğŸ”§ [4ë‹¨ê³„] í†µí•© ê°œì„ ëœ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function performSocialLogout() {
            console.log('ğŸ”§ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹œì‘');
            
            // 1ë‹¨ê³„: ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì •ë¦¬
            clearBrowserStorage();
            
            // 2ë‹¨ê³„: ì†Œì…œ ì œê³µìë³„ íŠ¹í™” ì •ë¦¬
            clearNaverSpecificData();
            
            // 3ë‹¨ê³„: ğŸ”¥ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ URL ì²˜ë¦¬ (ê°œì„ ëœ ë°©ì‹)
            if (socialLogoutUrl && socialLogoutUrl.trim() !== '') {
                console.log('ğŸ”§ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ URL ì²˜ë¦¬:', socialLogoutUrl);
                
                try {
                    if (provider === 'naver') {
                        // ğŸ”¥ ë„¤ì´ë²„ íŠ¹í™” ì²˜ë¦¬: ìƒˆ ì°½ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                        console.log('ğŸŸ¢ ë„¤ì´ë²„ ë¸Œë¼ìš°ì € ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ ì‹œì‘');
                        
                        // 1) ìƒˆ ì°½ì—ì„œ ë„¤ì´ë²„ ë¡œê·¸ì•„ì›ƒ URL ì—´ê¸°
                        const naverLogoutWindow = window.open(
                            decodeURIComponent(socialLogoutUrl), 
                            'naverLogout', 
                            'width=600,height=400,scrollbars=yes,resizable=yes'
                        );
                        
                        // 2) 3ì´ˆ í›„ ë„¤ì´ë²„ ë¡œê·¸ì•„ì›ƒ ì°½ ë‹«ê³  ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                        setTimeout(() => {
                            if (naverLogoutWindow && !naverLogoutWindow.closed) {
                                naverLogoutWindow.close();
                                console.log('âœ… ë„¤ì´ë²„ ë¡œê·¸ì•„ì›ƒ ì°½ ë‹«ìŒ');
                            }
                            
                            // 3) ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                            console.log('ğŸ ë„¤ì´ë²„ ì™„ì „ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™');
                            window.location.href = '/logout-complete?provider=naver';
                        }, 3000);
                        
                    } else {
                        // ë‹¤ë¥¸ ì†Œì…œ ì œê³µìëŠ” ì§ì ‘ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        console.log('ğŸ”§ ì§ì ‘ ë¦¬ë‹¤ì´ë ‰íŠ¸:', provider);
                        window.location.href = decodeURIComponent(socialLogoutUrl);
                    }
                    
                } catch (error) {
                    console.error('âŒ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/logout-complete?provider=' + (provider || '');
                }
                
            } else {
                console.log('âŒ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ URLì´ ì—†ì–´ ë°”ë¡œ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™');
                window.location.href = '/logout-complete?provider=' + (provider || '');
            }
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ ë° ìë™ ì§„í–‰ (ì‹œê°„ ë‹¨ì¶•)
        let seconds = 2; // 2ì´ˆë¡œ ë‹¨ì¶•í•˜ì—¬ ë¹ ë¥¸ ì²˜ë¦¬
        const countdownElement = document.getElementById('seconds');
        
        if (countdownElement) {
            countdownElement.textContent = seconds;
        }
        
        const timer = setInterval(() => {
            seconds--;
            if (countdownElement) {
                countdownElement.textContent = seconds;
            }
            
            if (seconds <= 0) {
                clearInterval(timer);
                performSocialLogout();
            }
        }, 1000);

        // í˜ì´ì§€ ë¡œë“œ í›„ ë¹ ë¥¸ ì†Œì…œ ë¡œê·¸ì•„ì›ƒ ì‹œì‘
        setTimeout(performSocialLogout, 500);
    </script>
</body>
</html>
